name: Fetch Commits and create issue with details

# on:
#   schedule:
#     - cron: '* * * * *'  # Runs daily at midnight UTC

on:
  push:
    branches: [ master ]

jobs:
  fetch-and-create-pr:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Repository gtfs-validator
        uses: actions/checkout@v4.0.0
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.FRED_PERSONAL_GITHUB_TOKEN }} 

      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      - name: Install dependencies
        run: npm install @actions/github

      - name: Set up Git
        id: git-setup
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          echo "user_name=github-actions[bot]" >> $GITHUB_OUTPUT
          echo "user_email=41898282+github-actions[bot]@users.noreply.github.com" >> $GITHUB_OUTPUT
          echo "reviewer=emmambd" >> $GITHUB_OUTPUT 
          echo "assigned=fredericsimard" >> $GITHUB_OUTPUT
        # Comma-separated list of reviewers and assignees

      - name: Calculate Dates
        id: dates
        run: |
          echo "yesterday=$(date -d '-1 day' '+%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Extract and process JSON
        id: process_json
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const response = await github.request('GET /repos/google/transit/commits', {
              owner: 'fredericsimard',
              repo: 'gtfs-validator-fork',
              path: 'gtfs/spec/en/reference.md',
              since: '2023-08-01T00:00:00Z',
            });
            
            const commits = response.data;
            core.setOutput('commits_data', commits)
            core.setOutput('commits_length', commits.length)

            if (commits.length > 0) {
              core.setOutput('condition_met', 'true');
            } else {
              core.setOutput('condition_met', 'false');
            }

      - name: Extract JSON Fields
        id: extract-fields
        run: |
          # Extract specific fields from the JSON and create a new JSON object
          extracted_data=$(echo '${{ steps.process_json.outputs.commits_data }}' | jq 'map({author: .commit.author.name, date: .commit.author.date, message: .commit.message, html_url: .html_url})')
      
          # Store the extracted JSON in an environment variable for later use
          echo "extracted_data=${extracted_data}" >> $GITHUB_OUTPUT
        shell: bash

        
      
      - name: Create Issue on Failed workflow
        if: steps.process_json.outputs.condition_met == 'true'
        uses: dacbd/create-issue-action@main
        with:
          token: ${{ secrets.FRED_PERSONAL_GITHUB_TOKEN }}
          title: Changes made to reference.md in the Google Transit repo.
          body: |
            ### Changes made to `reference.md` from Google Transit's repo
            Date: ${{ steps.dates.outputs.today }}
            Number of new commits: ${{ steps.process_json.outputs.commits_length }}
            Raw data:
            
            "${{ steps.extract-fields.outputs.extracted_data }}"
          assignees: ${{ steps.git-setup.outputs.assigned }}